# file: bundles-v25.html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Configuration Hub</title>
  <style>
    :root {
      --brand-blue: #1589ee;
      --dark-blue: #16325c;
      --light-gray: #f4f6f9;
      --border-gray: #d8dde6;
      --text-dark: #1a1a1a;
      --text-light: #63737a;
      --font: Arial, sans-serif;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: var(--font); background: var(--light-gray); color: var(--text-dark); }
    .app-container { display: flex; flex-direction: column; height: 100%; }
    header { background: var(--dark-blue); color: white; padding: 0 1em; display: flex; align-items: center; height: 50px; justify-content: space-between; }
    header h1 { font-size: 1.2em; }
    .body { flex: 1; display: flex; overflow: hidden; }
    nav { width: 220px; background: var(--brand-blue); display: flex; flex-direction: column; }
    nav a { color: white; text-decoration: none; padding: 1em; }
    nav a.active, nav a:hover { background: var(--dark-blue); }
    .main { flex: 1; overflow-y: auto; padding: 1em; }
    .section { display: none; }
    .section.active { display: block; }
    .card { background: white; border: 1px solid var(--border-gray); border-radius: 4px; padding: 1em; margin-bottom: 1em; }
    h2 { margin-bottom: 0.5em; color: var(--dark-blue); }
    label { display: block; margin: 0.5em 0 0.25em; font-weight: bold; }
    input[type="text"], textarea, select, input[type="number"], input[type="date"], input[type="url"], input[type="datetime-local"] { width: 100%; padding: 0.5em; border: 1px solid var(--border-gray); border-radius: 3px; }
    textarea { resize: vertical; height: 80px; }
    button { margin-top: 0.5em; background: var(--brand-blue); color: white; border: none; padding: 0.5em 1em; border-radius: 3px; cursor: pointer; }
    button.delete { background: #d9534f; margin-left: 0.5em; }
    button.update { background: #ffc107; color: #1a1a1a; margin-left: 0.5em;}
    table { width: 100%; border-collapse: collapse; margin-top: 0.5em; }
    th, td { border: 1px solid var(--border-gray); padding: 0.5em; text-align: left; }
    th { background: var(--light-gray); }
    .search-input { width: calc(100% - 2px); margin-bottom: 0.5em; }
    .wizard-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index:100; }
    .wizard-content { background: white; padding: 1em; border-radius: 5px; width: 700px; max-height: 90%; overflow-y: auto; }
    .wizard-step { display: none; }
    .wizard-step.active { display: block; }
    .wizard-buttons { text-align: right; margin-top: 1em; }
    .wizard-buttons button { margin-left: 0.5em; }
    .order-list { list-style: none; padding: 0; }
    .order-list li { margin: 0.25em 0; display: flex; justify-content: space-between; align-items: center; background: var(--light-gray); padding: 0.5em; border-radius: 3px; }
    .order-btn { background: transparent; border: none; cursor: pointer; color: var(--brand-blue); margin-left: 0.5em; }
    .error { color: #d9534f; font-size: 0.9em; margin-top: 0.25em; }
    .flex { display: flex; gap:1em; }
    .flex-column { display: flex; flex-direction: column; }
    .toggle-switch { position: relative; width: 50px; display: inline-block; }
    .toggle-switch input { display:none; }
    .slider { position: absolute; cursor: pointer; top:0; left:0; right:0; bottom:0; background-color: #ccc; transition:.4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left:4px; bottom:4px; background-color:white; transition:.4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--brand-blue); }
    input:checked + .slider:before { transform: translateX(26px); }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <h1>Configuration Hub</h1>
      <div>User: admin | <a href="#" style="color:white;text-decoration:underline;">Logout</a></div>
    </header>
    <div class="body">
      <nav>
        <a href="#" data-target="tenants">Tenants</a>
        <a href="#" data-target="submission-library" class="active">Submission Form Library</a>
        <a href="#" data-target="review-library">Review Form Library</a>
        <a href="#" data-target="entities">Entities</a>
        <a href="#" data-target="cohorts">Cohorts</a>
        <a href="#" data-target="bundles">Submission Bundles</a>
        <a href="#" data-target="rbundles">Review Bundles</a>
        <a href="#" data-target="deliverables">Deliverables</a>
      </nav>
      <div class="main">
        <section id="tenants" class="section">
          <h2>Manage Tenants</h2>
          <button id="open-tenant-wizard">New Tenant</button>
          <button id="delete-selected-tenants">Delete Selected</button>
          <div class="card">
            <label for="tenants-grid-search">Search Tenants</label>
            <input type="text" id="tenants-grid-search" class="search-input" placeholder="Search tenants...">
            <table>
              <thead><tr><th><input type="checkbox" id="tenants-select-all"></th><th>Name</th><th>Description</th><th>Actions</th></tr></thead>
              <tbody id="tenants-grid"></tbody>
            </table>
          </div>
        </section>
        <section id="submission-library" class="section active">
          <h2>Manage Submission Form Library</h2>
          <button id="open-lib-wizard">New Submission Form</button>
          <button id="delete-selected-sub">Delete Selected</button>
          <div class="card">
            <label for="submission-grid-search">Search Forms</label>
            <input type="text" id="submission-grid-search" class="search-input" placeholder="Search...">
            <table>
              <thead>
                <tr>
                  <th><input type="checkbox" id="sub-select-all"></th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Endpoint URL</th>
                  <th>Exit Event</th>
                  <th>API Auth Type</th>
                  <th>API Features</th>
                  <th>Schema</th>
                  <th>Validation Status</th>
                  <th>Options</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="submission-grid"></tbody>
            </table>
          </div>
        </section>
        <section id="review-library" class="section">
          <h2>Manage Review Form Library</h2>
          <button id="open-rlib-wizard">New Review Form</button>
          <button id="delete-selected-rev">Delete Selected</button>
          <div class="card">
            <label for="review-grid-search">Search Forms</label>
            <input type="text" id="review-grid-search" class="search-input" placeholder="Search...">
            <table>
              <thead>
                <tr>
                  <th><input type="checkbox" id="rev-select-all"></th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Endpoint URL</th>
                  <th>Exit Event</th>
                  <th>API Auth Type</th>
                  <th>API Features</th>
                  <th>Schema</th>
                  <th>Validation Status</th>
                  <th>Options</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="review-grid"></tbody>
            </table>
          </div>
        </section>
        <section id="entities" class="section">
          <h2>Manage Entities</h2>
          <button id="open-entity-wizard">New Entity</button>
          <button id="delete-selected-entities">Delete Selected</button>
          <div class="card">
            <label for="entities-grid-search">Search Entities</label>
            <input type="text" id="entities-grid-search" class="search-input" placeholder="Search entities...">
            <table>
              <thead><tr><th><input type="checkbox" id="entities-select-all"></th><th>Name</th><th>Type</th><th>Parent Entity</th><th># Child Entities</th><th>Actions</th></tr></thead>
              <tbody id="entities-grid"></tbody>
            </table>
          </div>
        </section>
        <section id="cohorts" class="section">
          <h2>Manage Cohorts</h2>
          <button id="open-cohort-wizard">New Cohort</button>
          <button id="delete-selected-cohort">Delete Selected</button>
          <div class="card">
            <table>
              <thead><tr><th><input type="checkbox" id="cohort-select-all"></th><th>Name</th><th>Description</th><th>Tags</th><th>Program</th><th>Entity Type</th><th># Entities</th><th>Actions</th></tr></thead>
              <tbody id="cohort-grid"></tbody>
            </table>
          </div>
        </section>
        <section id="bundles" class="section">
          <h2>Manage Submission Bundles</h2>
          <button id="open-bundle-wizard">New Bundle</button>
          <button id="delete-selected-bundle">Delete Selected</button>
          <div class="card">
            <label for="bundle-grid-search">Search Bundles</label>
            <input type="text" id="bundle-grid-search" class="search-input" placeholder="Search bundles...">
            <table>
              <thead><tr><th><input type="checkbox" id="bundle-select-all"></th><th>Name</th><th>Description</th><th>Program</th><th>Tags</th><th># Submission Forms</th><th>Review Enabled</th><th># Review Forms</th><th>Actions</th></tr></thead>
              <tbody id="bundle-grid"></tbody>
            </table>
          </div>
        </section>
        <section id="rbundles" class="section">
          <h2>Manage Review Bundles</h2>
          <button id="open-rbundle-wizard">New Review Bundle</button>
          <button id="delete-selected-rbundle">Delete Selected</button>
          <div class="card">
            <label for="rbundle-grid-search">Search Bundles</label>
            <input type="text" id="rbundle-grid-search" class="search-input" placeholder="Search bundles...">
            <table>
              <thead><tr><th><input type="checkbox" id="rbundle-select-all"></th><th>Name</th><th>Description</th><th>Program</th><th>Tags</th><th># Submission Forms</th><th>Review Enabled</th><th># Review Forms</th><th>Actions</th></tr></thead>
              <tbody id="rbundle-grid"></tbody>
            </table>
          </div>
        </section>
        <section id="deliverables" class="section">
          <h2>Manage Deliverables</h2>
          <button id="open-deliverable-wizard">New Deliverable</button>
          <button id="delete-selected-del">Delete Selected</button>
          <div class="card">
            <label for="deliverable-grid-search">Search Deliverables</label>
            <input type="text" id="deliverable-grid-search" class="search-input" placeholder="Search...">
            <table>
              <thead><tr><th><input type="checkbox" id="del-select-all"></th><th>Name</th><th>Cohort</th><th>Bundle</th><th>Schedule</th><th>Next Run</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="deliverable-grid"></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Submission Form Wizard -->
  <div id="lib-wizard-overlay" class="wizard-overlay">
    <div class="wizard-content">
      <h3 id="lib-wizard-title">New Submission Form</h3>
      <div id="lib-step-1" class="wizard-step active">
        <h4>Step 1: Metadata</h4>
        <div class="flex-column">
          <label for="lib-name">Name *</label>
          <input type="text" id="lib-name"><span class="error" id="lib-name-error"></span>
          <label for="lib-desc">Description</label>
          <textarea id="lib-desc"></textarea>
          <label for="lib-endpoint">Endpoint URL *</label>
          <input type="url" id="lib-endpoint"><span class="error" id="lib-endpoint-error"></span>
          <label for="lib-exit">Exit Event</label>
          <input type="text" id="lib-exit">
          <label for="lib-auth">Auth Type *</label>
          <select id="lib-auth"><option value="">Select</option><option>API Key</option><option>OAuth2</option></select><span class="error" id="lib-auth-error"></span>
          <label>API Features</label>
          <table id="lib-features-table">
            <thead>
              <tr><th>Feature</th><th>Verb</th><th>Endpoint</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <label for="lib-schema">Schema *</label>
          <select id="lib-schema"><option value="">Select</option><option>schema1.json</option><option>schema2.json</option></select><span class="error" id="lib-schema-error"></span>
        </div>
      </div>
      <div id="lib-step-2" class="wizard-step">
        <h4>Step 2: Validation</h4>
        <p>Review metadata and run validation tests:</p>
        <div id="lib-review"></div>
        <button id="lib-run-tests">Run Validation Tests</button>
        <div id="lib-test-status"></div>
      </div>
      <div class="wizard-buttons">
        <button id="lib-cancel">Cancel</button>
        <button id="lib-prev" style="display:none;">Prev</button>
        <button id="lib-next">Next</button>
        <button id="lib-finish" style="display:none;">Finish</button>
      </div>
    </div>
  </div>

  <!-- Review Form Wizard -->
  <div id="rlib-wizard-overlay" class="wizard-overlay">
    <div class="wizard-content">
      <h3 id="rlib-wizard-title">New Review Form</h3>
      <div id="rlib-step-1" class="wizard-step active">
        <h4>Step 1: Metadata</h4>
        <div class="flex-column">
          <label for="rlib-name">Name *</label>
          <input type="text" id="rlib-name"><span class="error" id="rlib-name-error"></span>
          <label for="rlib-desc">Description</label>
          <textarea id="rlib-desc"></textarea>
          <label for="rlib-endpoint">Endpoint URL *</label>
          <input type="url" id="rlib-endpoint"><span class="error" id="rlib-endpoint-error"></span>
          <label for="rlib-exit">Exit Event</label>
          <input type="text" id="rlib-exit">
          <label for="rlib-auth">Auth Type *</label>
          <select id="rlib-auth"><option value="">Select</option><option>API Key</option><option>OAuth2</option></select><span class="error" id="rlib-auth-error"></span>
          <label>API Features</label>
          <table id="rlib-features-table">
            <thead>
              <tr><th>Feature</th><th>Verb</th><th>Endpoint</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <label for="rlib-schema">Schema *</label>
          <select id="rlib-schema"><option value="">Select</option><option>schemaA.json</option><option>schemaB.json</option></select><span class="error" id="rlib-schema-error"></span>
        </div>
      </div>
      <div id="rlib-step-2" class="wizard-step">
        <h4>Step 2: Validation</h4>
        <p>Review metadata and run validation tests:</p>
        <div id="rlib-review"></div>
        <button id="rlib-run-tests">Run Validation Tests</button>
        <div id="rlib-test-status"></div>
      </div>
      <div class="wizard-buttons">
        <button id="rlib-cancel">Cancel</button>
        <button id="rlib-prev" style="display:none;">Prev</button>
        <button id="rlib-next">Next</button>
        <button id="rlib-finish" style="display:none;">Finish</button>
      </div>
    </div>
  </div>

  <!-- Cohort Wizard -->
  <div id="cohort-wizard-overlay" class="wizard-overlay">
    <div class="wizard-content">
      <h3 id="cohort-wizard-title">New Cohort</h3>
      <div id="cohort-step-1" class="wizard-step active">
        <h4>Step 1: Basic Info</h4>
        <label for="cohort-name">Name *</label>
        <input type="text" id="cohort-name"><span class="error" id="cohort-name-error"></span>
        <label for="cohort-desc">Description</label>
        <textarea id="cohort-desc"></textarea>
        <label for="cohort-tags">Tags (comma separated)</label>
        <input type="text" id="cohort-tags">
      </div>
      <div id="cohort-step-2" class="wizard-step">
        <h4>Step 2: Program & Entity Type</h4>
        <label for="cohort-prog">Program *</label>
        <select id="cohort-prog"><option value="">Select</option><option>330</option><option>LGP</option><option>LAL</option></select><span class="error" id="cohort-prog-error"></span>
        <label for="cohort-type">Entity Type *</label>
        <select id="cohort-type"><option value="">Select</option><option>applications</option><option>awards</option><option>organizations</option></select><span class="error" id="cohort-type-error"></span>
      </div>
      <div id="cohort-step-3" class="wizard-step">
        <h4>Step 3: Pick Entities</h4>
        <label for="cohort-entities-search">Search Entities</label>
        <input type="text" id="cohort-entities-search" class="search-input">
        <div class="flex">
          <div style="flex:1;">
            <h5>Available</h5>
            <ul id="cohort-entities-available" class="order-list"></ul>
          </div>
          <div style="flex:1;">
            <h5>Selected</h5>
            <ul id="cohort-entities-selected" class="order-list"></ul>
          </div>
        </div>
      </div>
      <div id="cohort-step-4" class="wizard-step">
        <h4>Step 4: Review & Finish</h4>
        <div id="cohort-summary"></div>
      </div>
      <div class="wizard-buttons">
        <button id="cohort-cancel">Cancel</button>
        <button id="cohort-prev" style="display:none;">Prev</button>
        <button id="cohort-next">Next</button>
        <button id="cohort-finish" style="display:none;">Finish</button>
      </div>
    </div>
  </div>

  <!-- Bundle Wizard -->
  <div id="bundle-wizard-overlay" class="wizard-overlay">
    <div class="wizard-content">
      <h3 id="bundle-wizard-title">New Submission Bundle</h3>
      <div id="bundle-step-1" class="wizard-step active">
        <h4>Step 1: Basics</h4>
        <label for="bundle-name">Name *</label>
        <input type="text" id="bundle-name"><span class="error" id="bundle-name-error"></span>
        <label for="bundle-desc">Description</label>
        <textarea id="bundle-desc"></textarea>
        <label for="bundle-prog">Program *</label>
        <select id="bundle-prog"><option value="">Select</option><option>330</option><option>LGP</option><option>LAL</option></select><span class="error" id="bundle-prog-error"></span>
        <label for="bundle-tags">Tags (comma separated)</label>
        <input type="text" id="bundle-tags">
      </div>
      <div id="bundle-step-2" class="wizard-step">
        <h4>Step 2: Submission Phase</h4>
        <label for="bundle-sub-search">Search Submission Forms</label>
        <input type="text" id="bundle-sub-search" class="search-input">
        <div class="flex">
          <div style="flex:1;">
            <h5>Available</h5><ul id="bundle-sub-avail" class="order-list"></ul>
          </div>
          <div style="flex:1;">
            <h5>Selected & Reorder</h5><ul id="bundle-sub-selected" class="order-list"></ul>
          </div>
        </div>
      </div>
      <div id="bundle-step-3" class="wizard-step">
        <h4>Step 3: Review Phase</h4>
        <label>Enable Review?</label>
        <label class="toggle-switch"><input type="checkbox" id="bundle-enable-review"><span class="slider"></span></label>
        <div id="bundle-review-section" style="display:none;">
          <label for="bundle-rev-search">Search Review Forms</label>
          <input type="text" id="bundle-rev-search" class="search-input">
          <div class="flex">
            <div style="flex:1;">
              <h5>Available</h5><ul id="bundle-rev-avail" class="order-list"></ul>
            </div>
            <div style="flex:1;">
              <h5>Selected & Reorder</h5><ul id="bundle-rev-selected" class="order-list"></ul>
            </div>
          </div>
        </div>
      </div>
      <div id="bundle-step-4" class="wizard-step">
        <h4>Step 4: Summary & Finish</h4>
        <div id="bundle-summary"></div>
      </div>
      <div class="wizard-buttons">
        <button id="bundle-cancel">Cancel</button>
        <button id="bundle-prev" style="display:none;">Prev</button>
        <button id="bundle-next">Next</button>
        <button id="bundle-finish" style="display:none;">Finish</button>
      </div>
    </div>
  </div>

  <!-- Review Bundle Wizard -->
  <div id="rbundle-wizard-overlay" class="wizard-overlay">
    <div class="wizard-content">
      <h3 id="rbundle-wizard-title">New Review Bundle</h3>
      <div id="rbundle-step-1" class="wizard-step active">
        <h4>Step 1: Basics</h4>
        <label for="rbundle-name">Name *</label>
        <input type="text" id="rbundle-name"><span class="error" id="rbundle-name-error"></span>
        <label for="rbundle-desc">Description</label>
        <textarea id="rbundle-desc"></textarea>
        <label for="rbundle-prog">Program *</label>
        <select id="rbundle-prog"><option value="">Select</option><option>330</option><option>LGP</option><option>LAL</option></select><span class="error" id="rbundle-prog-error"></span>
        <label for="rbundle-tags">Tags (comma separated)</label>
        <input type="text" id="rbundle-tags">
      </div>
      <div id="rbundle-step-2" class="wizard-step">
        <h4>Step 2: Submission Phase</h4>
        <label for="rbundle-sub-search">Search Submission Forms</label>
        <input type="text" id="rbundle-sub-search" class="search-input">
        <div class="flex">
          <div style="flex:1;">
            <h5>Available</h5><ul id="rbundle-sub-avail" class="order-list"></ul>
          </div>
          <div style="flex:1;">
            <h5>Selected & Reorder</h5><ul id="rbundle-sub-selected" class="order-list"></ul>
          </div>
        </div>
      </div>
      <div id="rbundle-step-3" class="wizard-step">
        <h4>Step 3: Review Phase</h4>
        <label>Enable Review?</label>
        <label class="toggle-switch"><input type="checkbox" id="rbundle-enable-review"><span class="slider"></span></label>
        <div id="rbundle-review-section" style="display:none;">
          <label for="rbundle-rev-search">Search Review Forms</label>
          <input type="text" id="rbundle-rev-search" class="search-input">
          <div class="flex">
            <div style="flex:1;">
              <h5>Available</h5><ul id="rbundle-rev-avail" class="order-list"></ul>
            </div>
            <div style="flex:1;">
              <h5>Selected & Reorder</h5><ul id="rbundle-rev-selected" class="order-list"></ul>
            </div>
          </div>
        </div>
      </div>
      <div id="rbundle-step-4" class="wizard-step">
        <h4>Step 4: Summary & Finish</h4>
        <div id="rbundle-summary"></div>
      </div>
      <div class="wizard-buttons">
        <button id="rbundle-cancel">Cancel</button>
        <button id="rbundle-prev" style="display:none;">Prev</button>
        <button id="rbundle-next">Next</button>
        <button id="rbundle-finish" style="display:none;">Finish</button>
      </div>
    </div>
  </div>

  <!-- Deliverable Wizard -->
  <div id="deliverable-wizard-overlay" class="wizard-overlay">
    <div class="wizard-content">
      <h3 id="del-wizard-title">New Deliverable</h3>
      <div id="del-step-1" class="wizard-step active">
        <h4>Step 1: Basic Info</h4>
        <label for="del-name">Name *</label>
        <input type="text" id="del-name"><span class="error" id="del-name-error"></span>
        <label for="del-cohort">Cohort *</label>
        <select id="del-cohort"><option value="">Select</option></select><span class="error" id="del-cohort-error"></span>
        <label for="del-bundle">Bundle *</label>
        <select id="del-bundle"><option value="">Select</option></select><span class="error" id="del-bundle-error"></span>
      </div>
      <div id="del-step-2" class="wizard-step">
        <h4>Step 2: Schedule</h4>
        <label><input type="radio" name="del-sched-type" value="one-time" checked> One-time</label>
        <label><input type="radio" name="del-sched-type" value="recurring"> Recurring</label>
        <div id="del-one-time">
          <label for="del-date">Date *</label>
          <input type="date" id="del-date"><span class="error" id="del-date-error"></span>
        </div>
        <div id="del-recurring" style="display:none;">
          <label for="del-cron">Cron Expression *</label>
          <input type="text" id="del-cron" placeholder="0 0 1 * *"><span class="error" id="del-cron-error"></span>
        </div>
      </div>
      <div id="del-step-3" class="wizard-step">
        <h4>Step 3: Notifications</h4>
        <label for="del-template">Email Template *</label>
        <select id="del-template"><option value="">Select</option><option>Template1</option><option>Template2</option></select><span class="error" id="del-template-error"></span>
        <label for="del-reminders">Reminder Days</label>
        <input type="text" id="del-reminders" placeholder="e.g. 1,3,7">
      </div>
      <div id="del-step-4" class="wizard-step">
        <h4>Step 4: Review & Finish</h4>
        <div id="del-summary"></div>
      </div>
      <div class="wizard-buttons">
        <button id="del-cancel">Cancel</button>
        <button id="del-prev" style="display:none;">Prev</button>
        <button id="del-next">Next</button>
        <button id="del-finish" style="display:none;">Finish</button>
      </div>
    </div>
  </div>

  <!-- Tenant Wizard -->
  <div id="tenant-wizard-overlay" class="wizard-overlay">
    <div class="wizard-content">
      <h3 id="tenant-wizard-title">New Tenant</h3>
      <div id="tenant-step-1" class="wizard-step active">
        <h4>Step 1: Basic Info</h4>
        <label for="tenant-name">Name *</label>
        <input type="text" id="tenant-name"><span class="error" id="tenant-name-error"></span>
        <label for="tenant-desc">Description</label>
        <textarea id="tenant-desc"></textarea>
      </div>
      <div id="tenant-step-2" class="wizard-step">
        <h4>Step 2: Review & Finish</h4>
        <div id="tenant-summary"></div>
      </div>
      <div class="wizard-buttons">
        <button id="tenant-cancel">Cancel</button>
        <button id="tenant-prev" style="display:none;">Prev</button>
        <button id="tenant-next">Next</button>
        <button id="tenant-finish" style="display:none;">Finish</button>
      </div>
    </div>
  </div>

  <!-- Entity Wizard -->
  <div id="entity-wizard-overlay" class="wizard-overlay">
    <div class="wizard-content">
      <h3 id="entity-wizard-title">New Entity</h3>
      <div id="entity-step-1" class="wizard-step active">
        <h4>Step 1: Basic Info</h4>
        <label for="entity-name">Name *</label>
        <input type="text" id="entity-name"><span class="error" id="entity-name-error"></span>
        <label for="entity-type">Type *</label>
        <select id="entity-type"><option value="">Select</option><option value="system">system</option><option value="user">user</option></select><span class="error" id="entity-type-error"></span>
      </div>
      <div id="entity-step-2" class="wizard-step">
        <h4>Step 2: Hierarchy</h4>
        <label for="entity-parent">Parent Entity</label>
        <select id="entity-parent"><option value="">None</option></select>
      </div>
      <div id="entity-step-3" class="wizard-step">
        <h4>Step 3: Attributes</h4>
        <button id="entity-add-attr">+ Add Field</button>
        <table id="entity-attributes-table">
          <thead><tr><th>Name</th><th>Type</th><th>Required</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="entity-step-4" class="wizard-step">
        <h4>Step 4: Review & Finish</h4>
        <div id="entity-summary"></div>
      </div>
      <div class="wizard-buttons">
        <button id="entity-cancel">Cancel</button>
        <button id="entity-prev" style="display:none;">Prev</button>
        <button id="entity-next">Next</button>
        <button id="entity-finish" style="display:none;">Finish</button>
      </div>
    </div>
  </div>

  <script>
    document.querySelectorAll('nav a').forEach(a=>{
      a.onclick=e=>{
        e.preventDefault();
        document.querySelectorAll('nav a').forEach(x=>x.classList.remove('active'));
        a.classList.add('active');
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
        document.getElementById(a.dataset.target).classList.add('active');
      };
    });

    const defaultFeatures = [
      {name:'Create Draft', verb:'POST', endpoint:'/api/forms'},
      {name:'Update Draft', verb:'PUT', endpoint:'/api/forms/{formId}'},
      {name:'Publish', verb:'POST', endpoint:'/api/forms/{formId}/publish'},
      {name:'List Forms', verb:'GET', endpoint:'/api/forms?type={submission|review}&status={draft|published}&page={n}&size={m}'},
      {name:'Get Form Details', verb:'GET', endpoint:'/api/forms/{formId}'},
      {name:'Delete Form', verb:'DELETE', endpoint:'/api/forms/{formId}'},
      {name:'List Versions', verb:'GET', endpoint:'/api/forms/{formId}/versions'},
      {name:'Get Version Details', verb:'GET', endpoint:'/api/forms/{formId}/versions/{version}'},
      {name:'Restore Version', verb:'POST', endpoint:'/api/forms/{formId}/versions/{version}/restore'},
      {name:'Health', verb:'GET', endpoint:'/api/health'}
    ];
    const submissionLibrary = [
      {id:'1',name:'Form 1A',description:'',exitEvent:'',endpoint:'https://api.example.com/forms/1A',auth:'API Key',apiFeatures:JSON.parse(JSON.stringify(defaultFeatures)),schema:'form1A-schema.json',lastValidationStatus:'Passed'},
      {id:'2',name:'Consolidated Budget',description:'',exitEvent:'',endpoint:'https://api.example.com/forms/budget',auth:'OAuth2',apiFeatures:JSON.parse(JSON.stringify(defaultFeatures)),schema:'budget-schema.json',lastValidationStatus:'Passed'},
      {id:'3',name:'BPHC Post Award Progress Report (FQHC)',description:'',exitEvent:'',endpoint:'https://api.hrsa.gov/forms/bphc-progress',auth:'API Key',apiFeatures:JSON.parse(JSON.stringify(defaultFeatures)),schema:'bphc-progress-schema-v1.json',lastValidationStatus:'Pending'},
      {id:'4',name:'Emergency Prep Report',description:'',exitEvent:'',endpoint:'https://api.example.com/forms/emergency',auth:'OAuth2',apiFeatures:JSON.parse(JSON.stringify(defaultFeatures)),schema:'emergency-schema.json',lastValidationStatus:'Failed'}
    ];
    const reviewLibrary = [
      {id:'1',name:'Scope PO Review',description:'',exitEvent:'',endpoint:'https://api.example.com/reviews/scope-po',auth:'API Key',apiFeatures:JSON.parse(JSON.stringify(defaultFeatures)),schema:'scope-po-schema.json',lastValidationStatus:'Passed'},
      {id:'2',name:'Environmental Review',description:'',exitEvent:'',endpoint:'https://api.example.com/reviews/environmental',auth:'OAuth2',apiFeatures:JSON.parse(JSON.stringify(defaultFeatures)),schema:'env-schema.json',lastValidationStatus:'Pending'},
      {id:'3',name:'BPHC Progress Review',description:'',exitEvent:'',endpoint:'https://api.hrsa.gov/reviews/bphc-progress',auth:'API Key',apiFeatures:JSON.parse(JSON.stringify(defaultFeatures)),schema:'bphc-review-schema-v1.json',lastValidationStatus:'Passed'}
    ];
    const dataStore = {
      330:{applications:['App1','App2'],awards:['Award1'],organizations:['Org1','Org2','Org3']},
      LGP:{applications:['LGP App1'],awards:['LGP Award1'],organizations:['LGP Org1']},
      LAL:{applications:['LAL App1'],awards:['LAL Award1'],organizations:['LAL Org1']}
    };
    let cohorts = [
      {id:'c1',name:'FQHC Grantees 330',desc:'Federally Qualified Health Center grantees under Section 330',tags:'HRSA,BPHC,330',program:'330',type:'organizations',entities:dataStore['330']['organizations']},
      {id:'c2',name:'Look-Alike Grantees',desc:'HRSA Look-Alike program grantees',tags:'HRSA,BPHC,LAL',program:'LAL',type:'organizations',entities:dataStore['LAL']['organizations']}
    ];
    let bundles = [
      {id:'b1',name:'HRSA Progress Report Bundle',desc:'Submission and review for HRSA BPHC Post Award Progress Reports',program:'330',tags:'ProgressReport,BPHC',submissionForms:['BPHC Post Award Progress Report (FQHC)'],reviewEnabled:true,reviewForms:['BPHC Progress Review']},
      {id:'b2',name:'Emergency Prep Bundle',desc:'Bundle for emergency preparedness report',program:'330',tags:'Emergency,BPHC',submissionForms:['Emergency Prep Report'],reviewEnabled:false,reviewForms:[]}
    ];
    let rbundles = JSON.parse(JSON.stringify(bundles));
    let deliverables = [
      {id:'d1',name:'July Progress Report',cohort:'FQHC Grantees 330',bundle:'HRSA Progress Report Bundle',schedule:'Recurring (0 0 1 */3 *)',nextRun:'2024-07-01',lastRunStatus:'Pending'},
      {id:'d2',name:'One-time Emergency Prep',cohort:'FQHC Grantees 330',bundle:'Emergency Prep Bundle',schedule:'One-time (2024-06-15)',nextRun:'2024-06-15',lastRunStatus:'Scheduled'}
    ];
    let tenants = [
      {id:'t1',name:'BPHC',description:'Bureau of Primary Health Care'},
      {id:'t2',name:'HAB',description:'HIV/AIDS Bureau'}
    ];
    let entities = [
      {id:'e1',name:'Organization',type:'system',parent:'',attributes:[],childCount:0}
    ];

    function renderGrid(grid, data, cols){
      grid.innerHTML='';
      data.forEach(item=>{
        const tr=document.createElement('tr');
        let html=`<td><input type="checkbox" data-name="${item.name}"></td>`;
        cols.forEach(c=>{
          const v=typeof c==='function'?c(item):item[c]||'';
          html+=`<td>${v}</td>`;
        });
        html+=`<td><button class="update" data-name="${item.name}">Update</button><button class="delete" data-name="${item.name}">Delete</button></td>`;
        tr.innerHTML=html; grid.appendChild(tr);
      });
    }

    // Submission
    const subGrid=document.getElementById('submission-grid'), subSearch=document.getElementById('submission-grid-search'), deleteSelectedSub=document.getElementById('delete-selected-sub');
    function renderSubmissionLibrary(){
      const q=subSearch.value.toLowerCase();
      const filtered=submissionLibrary.filter(f=>f.name.toLowerCase().includes(q));
      renderGrid(subGrid,filtered,[
        'name',
        item=>item.description,
        'endpoint',
        item=>item.exitEvent,
        'auth',
        item=>item.apiFeatures.map(f=>`${f.name} (${f.verb})`).join(', '),
        item=>item.schema,
        item=>item.lastValidationStatus,
        ()=>''
      ]);
      deleteSelectedSub.disabled=true; document.getElementById('sub-select-all').checked=false;
      subGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.onchange=()=>deleteSelectedSub.disabled=!subGrid.querySelectorAll('input[type="checkbox"]:checked').length);
      subGrid.querySelectorAll('.delete').forEach(btn=>{
        btn.onclick=()=>{const n=btn.dataset.name; if(confirm(`Delete submission form "${n}"?`)){const i=submissionLibrary.findIndex(x=>x.name===n);submissionLibrary.splice(i,1);renderSubmissionLibrary();}};
      });
      subGrid.querySelectorAll('.update').forEach(btn=>btn.onclick=()=>openLibWizard('edit',btn.dataset.name));
    }
    subSearch.oninput=renderSubmissionLibrary; renderSubmissionLibrary();
    document.getElementById('sub-select-all').onclick=e=>{subGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=e.target.checked);deleteSelectedSub.disabled=!e.target.checked;};
    deleteSelectedSub.onclick=()=>{
      const sel=Array.from(subGrid.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.dataset.name);
      if(sel.length&&confirm(`Delete ${sel.length} selected?`)){sel.forEach(n=>{const i=submissionLibrary.findIndex(x=>x.name===n);submissionLibrary.splice(i,1);});renderSubmissionLibrary();}
    };

    // Review
    const revGrid=document.getElementById('review-grid'), revSearch=document.getElementById('review-grid-search'), deleteSelectedRev=document.getElementById('delete-selected-rev');
    function renderReviewLibrary(){
      const q=revSearch.value.toLowerCase();
      const filtered=reviewLibrary.filter(f=>f.name.toLowerCase().includes(q));
      renderGrid(revGrid,filtered,[
        'name',
        item=>item.description,
        'endpoint',
        item=>item.exitEvent,
        'auth',
        item=>item.apiFeatures.map(f=>`${f.name} (${f.verb})`).join(', '),
        item=>item.schema,
        item=>item.lastValidationStatus,
        ()=>''
      ]);
      deleteSelectedRev.disabled=true; document.getElementById('rev-select-all').checked=false;
      revGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.onchange=()=>deleteSelectedRev.disabled=!revGrid.querySelectorAll('input[type="checkbox"]:checked').length);
      revGrid.querySelectorAll('.delete').forEach(btn=>{btn.onclick=()=>{const n=btn.dataset.name;if(confirm(`Delete review "${n}"?`)){const i=reviewLibrary.findIndex(x=>x.name===n);reviewLibrary.splice(i,1);renderReviewLibrary();}}});
      revGrid.querySelectorAll('.update').forEach(btn=>btn.onclick=()=>openRLibWizard('edit',btn.dataset.name));
    }
    revSearch.oninput=renderReviewLibrary; renderReviewLibrary();
    document.getElementById('rev-select-all').onclick=e=>{revGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=e.target.checked);deleteSelectedRev.disabled=!e.target.checked;};
    deleteSelectedRev.onclick=()=>{
      const sel=Array.from(revGrid.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.dataset.name);
      if(sel.length&&confirm(`Delete ${sel.length} selected?`)){sel.forEach(n=>{const i=reviewLibrary.findIndex(x=>x.name===n);reviewLibrary.splice(i,1);});renderReviewLibrary();}
    };

    // Tenants
    const tenantsGrid=document.getElementById('tenants-grid'), tenantsSearch=document.getElementById('tenants-grid-search'), deleteSelectedTenants=document.getElementById('delete-selected-tenants');
    function renderTenants(){
      const q=tenantsSearch.value.toLowerCase();
      const filtered=tenants.filter(t=>t.name.toLowerCase().includes(q));
      renderGrid(tenantsGrid,filtered,['name',item=>item.description]);
      deleteSelectedTenants.disabled=true; document.getElementById('tenants-select-all').checked=false;
      tenantsGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.onchange=()=>deleteSelectedTenants.disabled=!tenantsGrid.querySelectorAll('input[type="checkbox"]:checked').length);
      tenantsGrid.querySelectorAll('.delete').forEach(btn=>{btn.onclick=()=>{const n=btn.dataset.name;if(confirm(`Delete tenant "${n}"?`)){const i=tenants.findIndex(x=>x.name===n);tenants.splice(i,1);renderTenants();}}});
      tenantsGrid.querySelectorAll('.update').forEach(btn=>btn.onclick=()=>openTenantWizard('edit',btn.dataset.name));
    }
    tenantsSearch.oninput=renderTenants; renderTenants();
    document.getElementById('tenants-select-all').onclick=e=>{tenantsGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=e.target.checked);deleteSelectedTenants.disabled=!e.target.checked;};
    deleteSelectedTenants.onclick=()=>{
      const sel=Array.from(tenantsGrid.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.dataset.name);
      if(sel.length&&confirm(`Delete ${sel.length} selected?`)){sel.forEach(n=>{const i=tenants.findIndex(x=>x.name===n);tenants.splice(i,1);});renderTenants();}
    };

    // Entities
    const entitiesGrid=document.getElementById('entities-grid'), entitiesSearch=document.getElementById('entities-grid-search'), deleteSelectedEntities=document.getElementById('delete-selected-entities');
    function renderEntities(){
      const q=entitiesSearch.value.toLowerCase();
      const filtered=entities.filter(e=>e.name.toLowerCase().includes(q));
      renderGrid(entitiesGrid,filtered,['name','type',item=>{const p=entities.find(x=>x.id===item.parent);return p?p.name:'';},item=>item.childCount]);
      deleteSelectedEntities.disabled=true; document.getElementById('entities-select-all').checked=false;
      entitiesGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.onchange=()=>deleteSelectedEntities.disabled=!entitiesGrid.querySelectorAll('input[type="checkbox"]:checked').length);
      entitiesGrid.querySelectorAll('.delete').forEach(btn=>{btn.onclick=()=>{const n=btn.dataset.name;if(confirm(`Delete entity "${n}"?`)){const i=entities.findIndex(x=>x.name===n);entities.splice(i,1);renderEntities();}}});
      entitiesGrid.querySelectorAll('.update').forEach(btn=>btn.onclick=()=>openEntityWizard('edit',btn.dataset.name));
    }
    entitiesSearch.oninput=renderEntities; renderEntities();
    document.getElementById('entities-select-all').onclick=e=>{entitiesGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=e.target.checked);deleteSelectedEntities.disabled=!e.target.checked;};
    deleteSelectedEntities.onclick=()=>{
      const sel=Array.from(entitiesGrid.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.dataset.name);
      if(sel.length&&confirm(`Delete ${sel.length} selected?`)){sel.forEach(n=>{const i=entities.findIndex(x=>x.name===n);entities.splice(i,1);});renderEntities();}
    };

    // Cohorts
    const cohortGrid=document.getElementById('cohort-grid'), deleteSelectedCoh=document.getElementById('delete-selected-cohort');
    function renderCohorts(){
      renderGrid(cohortGrid,cohorts,[
        'name',
        item=>item.desc,
        item=>item.tags,
        'program',
        'type',
        item=>item.entities.length
      ]);
      deleteSelectedCoh.disabled=true; document.getElementById('cohort-select-all').checked=false;
      cohortGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.onchange=()=>deleteSelectedCoh.disabled=!cohortGrid.querySelectorAll('input[type="checkbox"]:checked').length);
      cohortGrid.querySelectorAll('.delete').forEach(btn=>{btn.onclick=()=>{const n=btn.dataset.name;if(confirm(`Delete cohort "${n}"?`)){const i=cohorts.findIndex(x=>x.name===n);cohorts.splice(i,1);renderCohorts();}}});
      cohortGrid.querySelectorAll('.update').forEach(btn=>btn.onclick=()=>openCohortWizard('edit',btn.dataset.name));
    }
    renderCohorts();
    document.getElementById('cohort-select-all').onclick=e=>{cohortGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=e.target.checked);deleteSelectedCoh.disabled=!e.target.checked;};
    deleteSelectedCoh.onclick=()=>{
      const sel=Array.from(cohortGrid.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.dataset.name);
      if(sel.length&&confirm(`Delete ${sel.length} selected?`)){sel.forEach(n=>{const i=cohorts.findIndex(x=>x.name===n);cohorts.splice(i,1);});renderCohorts();}
    };

    // Bundles
    const bundleGrid=document.getElementById('bundle-grid'), deleteSelectedBundle=document.getElementById('delete-selected-bundle');
    function renderBundles(){
      const q=document.getElementById('bundle-grid-search').value.toLowerCase();
      const filtered=bundles.filter(b=>b.name.toLowerCase().includes(q));
      renderGrid(bundleGrid,filtered,[
        'name',
        item=>item.desc,
        'program',
        item=>item.tags,
        item=>item.submissionForms.length,
        item=>item.reviewEnabled?'Yes':'No',
        item=>item.reviewForms.length
      ]);
      deleteSelectedBundle.disabled=true; document.getElementById('bundle-select-all').checked=false;
      bundleGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.onchange=()=>deleteSelectedBundle.disabled=!bundleGrid.querySelectorAll('input[type="checkbox"]:checked').length);
      bundleGrid.querySelectorAll('.delete').forEach(btn=>{btn.onclick=()=>{const n=btn.dataset.name;if(confirm(`Delete bundle "${n}"?`)){const i=bundles.findIndex(x=>x.name===n);bundles.splice(i,1);renderBundles();}}});
      bundleGrid.querySelectorAll('.update').forEach(btn=>btn.onclick=()=>openBundleWizard('edit',btn.dataset.name));
    }
    document.getElementById('bundle-grid-search').oninput=renderBundles; renderBundles();
    document.getElementById('bundle-select-all').onclick=e=>{bundleGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=e.target.checked);deleteSelectedBundle.disabled=!e.target.checked;};
    deleteSelectedBundle.onclick=()=>{
      const sel=Array.from(bundleGrid.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.dataset.name);
      if(sel.length&&confirm(`Delete ${sel.length} selected?`)){sel.forEach(n=>{const i=bundles.findIndex(x=>x.name===n);bundles.splice(i,1);});renderBundles();}
    };

    // Review Bundles
    const rbGrid=document.getElementById('rbundle-grid'), deleteSelectedRBundle=document.getElementById('delete-selected-rbundle');
    function renderRBundles(){
      const q=document.getElementById('rbundle-grid-search').value.toLowerCase();
      const filtered=rbundles.filter(b=>b.name.toLowerCase().includes(q));
      renderGrid(rbGrid,filtered,[
        'name',
        item=>item.desc,
        'program',
        item=>item.tags,
        item=>item.submissionForms.length,
        item=>item.reviewEnabled?'Yes':'No',
        item=>item.reviewForms.length
      ]);
      deleteSelectedRBundle.disabled=true; document.getElementById('rbundle-select-all').checked=false;
      rbGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.onchange=()=>deleteSelectedRBundle.disabled=!rbGrid.querySelectorAll('input[type="checkbox"]:checked').length);
      rbGrid.querySelectorAll('.delete').forEach(btn=>{btn.onclick=()=>{const n=btn.dataset.name;if(confirm(`Delete review bundle "${n}"?`)){const i=rbundles.findIndex(x=>x.name===n);rbundles.splice(i,1);renderRBundles();}}});
      rbGrid.querySelectorAll('.update').forEach(btn=>btn.onclick=()=>openRBundleWizard('edit',btn.dataset.name));
    }
    document.getElementById('rbundle-grid-search').oninput=renderRBundles; renderRBundles();
    document.getElementById('rbundle-select-all').onclick=e=>{rbGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=e.target.checked);deleteSelectedRBundle.disabled=!e.target.checked;};
    deleteSelectedRBundle.onclick=()=>{
      const sel=Array.from(rbGrid.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.dataset.name);
      if(sel.length&&confirm(`Delete ${sel.length} selected?`)){sel.forEach(n=>{const i=rbundles.findIndex(x=>x.name===n);rbundles.splice(i,1);});renderRBundles();}
    };

    // Deliverables
    const delGrid=document.getElementById('deliverable-grid'), deleteSelectedDel=document.getElementById('delete-selected-del');
    function renderDeliverables(){
      const q=document.getElementById('deliverable-grid-search').value.toLowerCase();
      const filtered=deliverables.filter(d=>d.name.toLowerCase().includes(q));
      renderGrid(delGrid,filtered,[
        'name',
        'cohort',
        'bundle',
        item=>item.schedule,
        'nextRun',
        'lastRunStatus'
      ]);
      deleteSelectedDel.disabled=true; document.getElementById('del-select-all').checked=false;
      delGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.onchange=()=>deleteSelectedDel.disabled=!delGrid.querySelectorAll('input[type="checkbox"]:checked').length);
      delGrid.querySelectorAll('.delete').forEach(btn=>{btn.onclick=()=>{const n=btn.dataset.name;if(confirm(`Delete deliverable "${n}"?`)){const i=deliverables.findIndex(x=>x.name===n);deliverables.splice(i,1);renderDeliverables();}}});
      delGrid.querySelectorAll('.update').forEach(btn=>btn.onclick=()=>openDeliverableWizard('edit',btn.dataset.name));
    }
    document.getElementById('deliverable-grid-search').oninput=renderDeliverables; renderDeliverables();
    document.getElementById('del-select-all').onclick=e=>{delGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=e.target.checked);deleteSelectedDel.disabled=!e.target.checked;};
    deleteSelectedDel.onclick=()=>{
      const sel=Array.from(delGrid.querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.dataset.name);
      if(sel.length&&confirm(`Delete ${sel.length} selected?`)){sel.forEach(n=>{const i=deliverables.findIndex(x=>x.name===n);deliverables.splice(i,1);});renderDeliverables();}
    };

    // Wizard generic functions
    function showStep(overlay, step){
      overlay.querySelectorAll('.wizard-step').forEach((el,i)=>{el.classList.toggle('active', i+1===step);});
    }

    // Submission Wizard logic
    let libState={}, libMode='create';
    const libOverlay=document.getElementById('lib-wizard-overlay');
    function fillLibFeaturesTable(features){
      const tbody=document.querySelector('#lib-features-table tbody');
      tbody.innerHTML='';
      features.forEach(f=>{
        const tr=document.createElement('tr');
        tr.dataset.feature=f.name;
        tr.innerHTML=`
          <td>${f.name}</td>
          <td><select class="feature-verb"><option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option></select></td>
          <td><input type="text" class="feature-endpoint" value=""></td>`;
        tbody.appendChild(tr);
        tr.querySelector('.feature-verb').value=f.verb;
        tr.querySelector('.feature-endpoint').value=f.endpoint;
      });
    }
    function openLibWizard(mode,name){
      libMode=mode; libState={apiFeatures:[]};
      libOverlay.style.display='flex';
      document.getElementById('lib-wizard-title').innerText= mode==='edit'?'Edit Submission Form':'New Submission Form';
      showLibStep(1);
      if(mode==='edit'){
        const item=submissionLibrary.find(x=>x.name===name);
        libState=JSON.parse(JSON.stringify(item));
        document.getElementById('lib-name').value=item.name;
        document.getElementById('lib-desc').value=item.description;
        document.getElementById('lib-endpoint').value=item.endpoint;
        document.getElementById('lib-exit').value=item.exitEvent;
        document.getElementById('lib-auth').value=item.auth;
        document.getElementById('lib-schema').value=item.schema;
        fillLibFeaturesTable(item.apiFeatures);
      } else {
        document.querySelectorAll('#lib-wizard-overlay input, #lib-wizard-overlay select, #lib-wizard-overlay textarea').forEach(el=>el.value='');
        document.querySelectorAll('#lib-wizard-overlay .error').forEach(e=>e.innerText='');
        fillLibFeaturesTable(defaultFeatures);
      }
    }
    document.getElementById('open-lib-wizard').onclick=()=>openLibWizard('create');
    document.getElementById('lib-cancel').onclick=()=>libOverlay.style.display='none';
    function showLibStep(n){
      showStep(libOverlay, n);
      document.getElementById('lib-prev').style.display=n>1?'inline-block':'none';
      document.getElementById('lib-next').style.display=n<2?'inline-block':'none';
      document.getElementById('lib-finish').style.display=n===2?'inline-block':'none';
      libOverlay.dataset.step=n;
    }
    document.getElementById('lib-next').onclick=()=>{
      let ok=true;
      if(!document.getElementById('lib-name').value.trim()){document.getElementById('lib-name-error').innerText='Required'; ok=false;} else document.getElementById('lib-name-error').innerText='';
      if(!document.getElementById('lib-endpoint').value.trim()){document.getElementById('lib-endpoint-error').innerText='Required'; ok=false;} else document.getElementById('lib-endpoint-error').innerText='';
      if(!document.getElementById('lib-auth').value){document.getElementById('lib-auth-error').innerText='Required'; ok=false;} else document.getElementById('lib-auth-error').innerText='';
      if(!document.getElementById('lib-schema').value){document.getElementById('lib-schema-error').innerText='Required'; ok=false;} else document.getElementById('lib-schema-error').innerText='';
      if(ok){
        libState.name=document.getElementById('lib-name').value.trim();
        libState.description=document.getElementById('lib-desc').value;
        libState.endpoint=document.getElementById('lib-endpoint').value;
        libState.exitEvent=document.getElementById('lib-exit').value;
        libState.auth=document.getElementById('lib-auth').value;
        libState.schema=document.getElementById('lib-schema').value;
        libState.apiFeatures=Array.from(document.querySelectorAll('#lib-features-table tbody tr')).map(tr=>({
          name: tr.dataset.feature,
          verb: tr.querySelector('.feature-verb').value,
          endpoint: tr.querySelector('.feature-endpoint').value
        }));
        document.getElementById('lib-review').innerHTML=`
          <p><strong>Name:</strong> ${libState.name}</p>
          <p><strong>Endpoint:</strong> ${libState.endpoint}</p>
          <p><strong>Auth:</strong> ${libState.auth}</p>
          <p><strong>Schema:</strong> ${libState.schema}</p>
          <p><strong>API Features:</strong><br>${libState.apiFeatures.map(f=>`${f.name} (${f.verb} ${f.endpoint})`).join('<br>')}</p>`;
        showLibStep(2);
      }
    };
    document.getElementById('lib-prev').onclick=()=>showLibStep(1);
    document.getElementById('lib-run-tests').onclick=()=>{
      document.getElementById('lib-test-status').innerText='Running tests...';
      setTimeout(()=>document.getElementById('lib-test-status').innerText='All tests passed.',500);
    };
    document.getElementById('lib-finish').onclick=()=>{
      if(libMode==='create'){
        libState.id=Date.now().toString();
        libState.lastValidationStatus='Pending';
        submissionLibrary.push(libState);
      } else {
        const idx=submissionLibrary.findIndex(x=>x.id===libState.id);
        submissionLibrary[idx]=libState;
      }
      libOverlay.style.display='none'; renderSubmissionLibrary();
    };

    // Review Wizard
    let rlibState={}, rlibMode='create';
    const rlibOverlay=document.getElementById('rlib-wizard-overlay');
    function fillRLibFeaturesTable(features){
      const tbody=document.querySelector('#rlib-features-table tbody');
      tbody.innerHTML='';
      features.forEach(f=>{
        const tr=document.createElement('tr');
        tr.dataset.feature=f.name;
        tr.innerHTML=`
          <td>${f.name}</td>
          <td><select class="feature-verb"><option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option></select></td>
          <td><input type="text" class="feature-endpoint" value=""></td>`;
        tbody.appendChild(tr);
        tr.querySelector('.feature-verb').value=f.verb;
        tr.querySelector('.feature-endpoint').value=f.endpoint;
      });
    }
    function openRLibWizard(mode,name){
      rlibMode=mode; rlibState={apiFeatures:[]};
      rlibOverlay.style.display='flex';
      document.getElementById('rlib-wizard-title').innerText= mode==='edit'?'Edit Review Form':'New Review Form';
      showRLibStep(1);
      if(mode==='edit'){
        const item=reviewLibrary.find(x=>x.name===name);
        rlibState=JSON.parse(JSON.stringify(item));
        document.getElementById('rlib-name').value=item.name;
        document.getElementById('rlib-desc').value=item.description;
        document.getElementById('rlib-endpoint').value=item.endpoint;
        document.getElementById('rlib-exit').value=item.exitEvent;
        document.getElementById('rlib-auth').value=item.auth;
        document.getElementById('rlib-schema').value=item.schema;
        fillRLibFeaturesTable(item.apiFeatures);
      } else {
        document.querySelectorAll('#rlib-wizard-overlay input, #rlib-wizard-overlay select, #rlib-wizard-overlay textarea').forEach(el=>el.value='');
        document.querySelectorAll('#rlib-wizard-overlay .error').forEach(e=>e.innerText='');
        fillRLibFeaturesTable(defaultFeatures);
      }
    }
    document.getElementById('open-rlib-wizard').onclick=()=>openRLibWizard('create');
    document.getElementById('rlib-cancel').onclick=()=>rlibOverlay.style.display='none';
    function showRLibStep(n){
      showStep(rlibOverlay, n);
      document.getElementById('rlib-prev').style.display=n>1?'inline-block':'none';
      document.getElementById('rlib-next').style.display=n<2?'inline-block':'none';
      document.getElementById('rlib-finish').style.display=n===2?'inline-block':'none';
      rlibOverlay.dataset.step=n;
    }
    document.getElementById('rlib-next').onclick=()=>{
      let ok=true;
      if(!document.getElementById('rlib-name').value.trim()){document.getElementById('rlib-name-error').innerText='Required'; ok=false;} else document.getElementById('rlib-name-error').innerText='';
      if(!document.getElementById('rlib-endpoint').value.trim()){document.getElementById('rlib-endpoint-error').innerText='Required'; ok=false;} else document.getElementById('rlib-endpoint-error').innerText='';
      if(!document.getElementById('rlib-auth').value){document.getElementById('rlib-auth-error').innerText='Required'; ok=false;} else document.getElementById('rlib-auth-error').innerText='';
      if(!document.getElementById('rlib-schema').value){document.getElementById('rlib-schema-error').innerText='Required'; ok=false;} else document.getElementById('rlib-schema-error').innerText='';
      if(ok){
        rlibState.name=document.getElementById('rlib-name').value.trim();
        rlibState.description=document.getElementById('rlib-desc').value;
        rlibState.endpoint=document.getElementById('rlib-endpoint').value;
        rlibState.exitEvent=document.getElementById('rlib-exit').value;
        rlibState.auth=document.getElementById('rlib-auth').value;
        rlibState.schema=document.getElementById('rlib-schema').value;
        rlibState.apiFeatures=Array.from(document.querySelectorAll('#rlib-features-table tbody tr')).map(tr=>({
          name: tr.dataset.feature,
          verb: tr.querySelector('.feature-verb').value,
          endpoint: tr.querySelector('.feature-endpoint').value
        }));
        document.getElementById('rlib-review').innerHTML=`
          <p><strong>Name:</strong> ${rlibState.name}</p>
          <p><strong>Endpoint:</strong> ${rlibState.endpoint}</p>
          <p><strong>Auth:</strong> ${rlibState.auth}</p>
          <p><strong>Schema:</strong> ${rlibState.schema}</p>
          <p><strong>API Features:</strong><br>${rlibState.apiFeatures.map(f=>`${f.name} (${f.verb} ${f.endpoint})`).join('<br>')}</p>`;
        showRLibStep(2);
      }
    };
    document.getElementById('rlib-prev').onclick=()=>showRLibStep(1);
    document.getElementById('rlib-run-tests').onclick=()=>{
      document.getElementById('rlib-test-status').innerText='Running tests...';
      setTimeout(()=>document.getElementById('rlib-test-status').innerText='All tests passed.',500);
    };
    document.getElementById('rlib-finish').onclick=()=>{
      if(rlibMode==='create'){
        rlibState.id=Date.now().toString();
        rlibState.lastValidationStatus='Pending';
        reviewLibrary.push(rlibState);
      } else {
        const idx=reviewLibrary.findIndex(x=>x.id===rlibState.id);
        reviewLibrary[idx]=rlibState;
      }
      rlibOverlay.style.display='none'; renderReviewLibrary();
    };

    // Cohort Wizard
    let cohortState={}, cohortMode='create';
    const cwOverlay=document.getElementById('cohort-wizard-overlay');
    function openCohortWizard(mode,name){
      cohortMode=mode; cohortState={entities:[]};
      cwOverlay.style.display='flex';
      document.getElementById('cohort-wizard-title').innerText= mode==='edit'?'Edit Cohort':'New Cohort';
      showCohortStep(1);
      document.querySelectorAll('#cohort-wizard-overlay input, #cohort-wizard-overlay select, #cohort-wizard-overlay textarea').forEach(el=>el.value='');
      document.querySelectorAll('#cohort-wizard-overlay .error').forEach(e=>e.innerText='');
      document.getElementById('cohort-entities-available').innerHTML='';
      document.getElementById('cohort-entities-selected').innerHTML='';
      if(mode==='edit'){
        const item=cohorts.find(x=>x.name===name);
        cohortState=JSON.parse(JSON.stringify(item));
        document.getElementById('cohort-name').value=item.name;
        document.getElementById('cohort-desc').value=item.desc;
        document.getElementById('cohort-tags').value=item.tags;
        document.getElementById('cohort-prog').value=item.program;
        document.getElementById('cohort-type').value=item.type;
        populateCohortEntities();
        item.entities.forEach(e=>addListItem('cohort-entities-selected',e,true));
      }
    }
    document.getElementById('open-cohort-wizard').onclick=()=>openCohortWizard('create');
    document.getElementById('cohort-cancel').onclick=()=>cwOverlay.style.display='none';
    function showCohortStep(n){
      showStep(cwOverlay, n);
      document.getElementById('cohort-prev').style.display=n>1?'inline-block':'none';
      document.getElementById('cohort-next').style.display=n<4?'inline-block':'none';
      document.getElementById('cohort-finish').style.display=n===4?'inline-block':'none';
      cwOverlay.dataset.step=n;
      if(n===3) populateCohortEntities();
      if(n===4) showCohortSummary();
    }
    document.getElementById('cohort-next').onclick=()=>{
      let step=parseInt(cwOverlay.dataset.step), ok=true;
      if(step===1){
        if(!document.getElementById('cohort-name').value.trim()){document.getElementById('cohort-name-error').innerText='Required'; ok=false;} else document.getElementById('cohort-name-error').innerText='';
      }
      if(step===2){
        if(!document.getElementById('cohort-prog').value){document.getElementById('cohort-prog-error').innerText='Required'; ok=false;} else document.getElementById('cohort-prog-error').innerText='';
        if(!document.getElementById('cohort-type').value){document.getElementById('cohort-type-error').innerText='Required'; ok=false;} else document.getElementById('cohort-type-error').innerText='';
      }
      if(ok) {
        if(step===1){
          cohortState.name=document.getElementById('cohort-name').value.trim();
          cohortState.desc=document.getElementById('cohort-desc').value;
          cohortState.tags=document.getElementById('cohort-tags').value;
        }
        if(step===2){
          cohortState.program=document.getElementById('cohort-prog').value;
          cohortState.type=document.getElementById('cohort-type').value;
        }
        showCohortStep(step+1);
      }
    };
    document.getElementById('cohort-prev').onclick=()=>{
      showCohortStep(parseInt(cwOverlay.dataset.step)-1);
    };
    function populateCohortEntities(){
      const avail=document.getElementById('cohort-entities-available');
      avail.innerHTML='';
      const prog=cohortState.program||document.getElementById('cohort-prog').value;
      const type=cohortState.type||document.getElementById('cohort-type').value;
      if(dataStore[prog] && dataStore[prog][type]){
        dataStore[prog][type].forEach(e=>addListItem('cohort-entities-available',e,false));
      }
    }
    document.getElementById('cohort-entities-search').oninput=()=>{
      const q=document.getElementById('cohort-entities-search').value.toLowerCase();
      Array.from(document.getElementById('cohort-entities-available').children).forEach(li=>{
        li.style.display=li.dataset.value.toLowerCase().includes(q)?'flex':'none';
      });
    };
    function addListItem(listId,text,selected){
      const ul=document.getElementById(listId);
      if(Array.from(ul.children).some(li=>li.dataset.value===text)) return;
      const li=document.createElement('li');
      li.dataset.value=text; li.innerHTML=`<span>${text}</span><button class="order-btn">${selected?'−':'+'}</button>`;
      ul.appendChild(li);
      li.querySelector('button').onclick=()=>{
        li.remove();
        const target=listId==='cohort-entities-available'?'cohort-entities-selected':'cohort-entities-available';
        addListItem(target,text, target==='cohort-entities-selected');
      };
    }
    function showCohortSummary(){
      const sum=document.getElementById('cohort-summary');
      sum.innerHTML=`
        <p><strong>Name:</strong> ${cohortState.name}</p>
        <p><strong>Description:</strong> ${cohortState.desc}</p>
        <p><strong>Tags:</strong> ${cohortState.tags}</p>
        <p><strong>Program:</strong> ${cohortState.program}</p>
        <p><strong>Type:</strong> ${cohortState.type}</p>
        <p><strong>Entities:</strong> ${Array.from(document.getElementById('cohort-entities-selected').children).map(li=>li.dataset.value).join(', ')}</p>`;
    }
    document.getElementById('cohort-finish').onclick=()=>{
      cohortState.entities=Array.from(document.getElementById('cohort-entities-selected').children).map(li=>li.dataset.value);
      cohortState.id=cohortMode==='create'?Date.now().toString():cohortState.id;
      if(cohortMode==='create') cohorts.push(cohortState);
      cwOverlay.style.display='none'; renderCohorts();
    };

    // Bundle Wizard
    let bundleState={}, bundleMode='create';
    const bwOverlay=document.getElementById('bundle-wizard-overlay');
    function openBundleWizard(mode,name){
      bundleMode=mode; bundleState={submissionForms:[],reviewForms:[]};
      bwOverlay.style.display='flex';
      document.getElementById('bundle-wizard-title').innerText= mode==='edit'?'Edit Submission Bundle':'New Submission Bundle';
      showBundleStep(1);
      document.querySelectorAll('#bundle-wizard-overlay input, #bundle-wizard-overlay select, #bundle-wizard-overlay textarea').forEach(el=>el.value='');
      document.querySelectorAll('#bundle-wizard-overlay .error').forEach(e=>e.innerText='');
      document.getElementById('bundle-sub-avail').innerHTML='';
      document.getElementById('bundle-sub-selected').innerHTML='';
      document.getElementById('bundle-rev-avail').innerHTML='';
      document.getElementById('bundle-rev-selected').innerHTML='';
      document.getElementById('bundle-enable-review').checked=false;
      document.getElementById('bundle-review-section').style.display='none';
      if(mode==='edit'){
        const item=bundles.find(x=>x.name===name);
        bundleState=JSON.parse(JSON.stringify(item));
        document.getElementById('bundle-name').value=item.name;
        document.getElementById('bundle-desc').value=item.desc;
        document.getElementById('bundle-prog').value=item.program;
        document.getElementById('bundle-tags').value=item.tags;
        populateBundleSub();
        item.submissionForms.forEach(f=>addListItemBundle('bundle-sub-selected',f));
        document.getElementById('bundle-enable-review').checked=item.reviewEnabled;
        if(item.reviewEnabled){
          document.getElementById('bundle-review-section').style.display='block';
          populateBundleRev();
          item.reviewForms.forEach(f=>addListItemBundle('bundle-rev-selected',f,true));
        }
      }
    }
    document.getElementById('open-bundle-wizard').onclick=()=>openBundleWizard('create');
    document.getElementById('bundle-cancel').onclick=()=>bwOverlay.style.display='none';
    function showBundleStep(n){
      showStep(bwOverlay, n);
      document.getElementById('bundle-prev').style.display=n>1?'inline-block':'none';
      document.getElementById('bundle-next').style.display=n<4?'inline-block':'none';
      document.getElementById('bundle-finish').style.display=n===4?'inline-block':'none';
      bwOverlay.dataset.step=n;
    }
    document.getElementById('bundle-next').onclick=()=>{
      let step=parseInt(bwOverlay.dataset.step), ok=true;
      if(step===1){
        if(!document.getElementById('bundle-name').value.trim()){document.getElementById('bundle-name-error').innerText='Required'; ok=false;} else document.getElementById('bundle-name-error').innerText='';
        if(!document.getElementById('bundle-prog').value){document.getElementById('bundle-prog-error').innerText='Required'; ok=false;} else document.getElementById('bundle-prog-error').innerText='';
      }
      if(ok){
        if(step===1){
          bundleState.name=document.getElementById('bundle-name').value.trim();
          bundleState.desc=document.getElementById('bundle-desc').value;
          bundleState.program=document.getElementById('bundle-prog').value;
          bundleState.tags=document.getElementById('bundle-tags').value;
          populateBundleSub();
        }
        if(step===2){
          bundleState.submissionForms=Array.from(document.getElementById('bundle-sub-selected').children).map(li=>li.dataset.value);
        }
        if(step===3){
          bundleState.reviewEnabled=document.getElementById('bundle-enable-review').checked;
          if(bundleState.reviewEnabled) bundleState.reviewForms=Array.from(document.getElementById('bundle-rev-selected').children).map(li=>li.dataset.value);
        }
        if(step===3 && bundleState.reviewEnabled) populateBundleRev();
        showBundleStep(step+1);
        if(step+1===4) showBundleSummary();
      }
    };
    document.getElementById('bundle-prev').onclick=()=>showBundleStep(parseInt(bwOverlay.dataset.step)-1);
    function populateBundleSub(){
      const avail=document.getElementById('bundle-sub-avail');
      avail.innerHTML='';
      submissionLibrary.forEach(f=>addListItemBundle('bundle-sub-avail',f.name,false));
    }
    document.getElementById('bundle-sub-search').oninput=()=>{
      const q=document.getElementById('bundle-sub-search').value.toLowerCase();
      Array.from(document.getElementById('bundle-sub-avail').children).forEach(li=>{
        li.style.display=li.dataset.value.toLowerCase().includes(q)?'flex':'none';
      });
    };
    function populateBundleRev(){
      const avail=document.getElementById('bundle-rev-avail');
      avail.innerHTML='';
      reviewLibrary.forEach(f=>addListItemBundle('bundle-rev-avail',f.name,false));
    }
    document.getElementById('bundle-rev-search').oninput=()=>{
      const q=document.getElementById('bundle-rev-search').value.toLowerCase();
      Array.from(document.getElementById('bundle-rev-avail').children).forEach(li=>{
        li.style.display=li.dataset.value.toLowerCase().includes(q)?'flex':'none';
      });
    };
    document.getElementById('bundle-enable-review').onchange=e=>{
      document.getElementById('bundle-review-section').style.display=e.target.checked?'block':'none';
    };
    function addListItemBundle(listId,text,selected){
      const ul=document.getElementById(listId);
      if(Array.from(ul.children).some(li=>li.dataset.value===text)) return;
      const li=document.createElement('li');
      li.dataset.value=text;
      li.innerHTML=`<span>${text}</span><div>
        ${selected?'<button class="order-btn">↑</button><button class="order-btn">↓</button>':''}
        <button class="order-btn">${selected?'-':'+'}</button>
      </div>`;
      ul.appendChild(li);
      const btn=li.querySelector('button:last-child');
      btn.onclick=()=>{
        li.remove();
        const target=listId==='bundle-sub-avail'?'bundle-sub-selected':'bundle-sub-avail';
        if(listId.startsWith('bundle-rev')) target=listId==='bundle-rev-avail'?'bundle-rev-selected':'bundle-rev-avail';
        addListItemBundle(target,text,target.endsWith('selected'));
      };
      if(selected){
        const up=li.querySelector('button:first-child');
        const down=li.querySelector('button:nth-child(2)');
        up.onclick=()=>{const prev=li.previousElementSibling; if(prev) ul.insertBefore(li,prev);}
        down.onclick=()=>{const next=li.nextElementSibling; if(next) ul.insertBefore(next,li);}
      }
    }
    function showBundleSummary(){
      const sum=document.getElementById('bundle-summary');
      sum.innerHTML=`
        <p><strong>Name:</strong> ${bundleState.name}</p>
        <p><strong>Description:</strong> ${bundleState.desc}</p>
        <p><strong>Program:</strong> ${bundleState.program}</p>
        <p><strong>Tags:</strong> ${bundleState.tags}</p>
        <p><strong>Submission Forms:</strong> ${bundleState.submissionForms.join(', ')}</p>
        <p><strong>Review Enabled:</strong> ${bundleState.reviewEnabled?'Yes':'No'}</p>
        <p><strong>Review Forms:</strong> ${bundleState.reviewForms.join(', ')}</p>`;
    }
    document.getElementById('bundle-finish').onclick=()=>{
      bundleState.id=bundleMode==='create'?Date.now().toString():bundleState.id;
      if(bundleMode==='create') bundles.push(bundleState);
      else { const idx=bundles.findIndex(x=>x.id===bundleState.id); bundles[idx]=bundleState; }
      bwOverlay.style.display='none'; renderBundles();
    };

    // Review Bundle Wizard
    let rbState={}, rbMode='create';
    const rbwOverlay=document.getElementById('rbundle-wizard-overlay');
    function openRBundleWizard(mode,name){
      rbMode=mode; rbState={submissionForms:[],reviewForms:[]};
      rbwOverlay.style.display='flex';
      document.getElementById('rbundle-wizard-title').innerText= mode==='edit'?'Edit Review Bundle':'New Review Bundle';
      showRBundleStep(1);
      document.querySelectorAll('#rbundle-wizard-overlay input, #rbundle-wizard-overlay select, #rbundle-wizard-overlay textarea').forEach(el=>el.value='');
      document.querySelectorAll('#rbundle-wizard-overlay .error').forEach(e=>e.innerText='');
      document.getElementById('rbundle-sub-avail').innerHTML='';
      document.getElementById('rbundle-sub-selected').innerHTML='';
      document.getElementById('rbundle-rev-avail').innerHTML='';
      document.getElementById('rbundle-rev-selected').innerHTML='';
      document.getElementById('rbundle-enable-review').checked=false;
      document.getElementById('rbundle-review-section').style.display='none';
      if(mode==='edit'){
        const item=rbundles.find(x=>x.name===name);
        rbState=JSON.parse(JSON.stringify(item));
        document.getElementById('rbundle-name').value=item.name;
        document.getElementById('rbundle-desc').value=item.desc;
        document.getElementById('rbundle-prog').value=item.program;
        document.getElementById('rbundle-tags').value=item.tags;
        populateRBundleSub();
        item.submissionForms.forEach(f=>addListItemRBundle('rbundle-sub-selected',f));
        document.getElementById('rbundle-enable-review').checked=item.reviewEnabled;
        if(item.reviewEnabled){
          document.getElementById('rbundle-review-section').style.display='block';
          populateRBundleRev();
          item.reviewForms.forEach(f=>addListItemRBundle('rbundle-rev-selected',f,true));
        }
      }
    }
    document.getElementById('open-rbundle-wizard').onclick=()=>openRBundleWizard('create');
    document.getElementById('rbundle-cancel').onclick=()=>rbwOverlay.style.display='none';
    function showRBundleStep(n){
      showStep(rbwOverlay, n);
      document.getElementById('rbundle-prev').style.display=n>1?'inline-block':'none';
      document.getElementById('rbundle-next').style.display=n<4?'inline-block':'none';
      document.getElementById('rbundle-finish').style.display=n===4?'inline-block':'none';
      rbwOverlay.dataset.step=n;
    }
    document.getElementById('rbundle-next').onclick=()=>{
      let step=parseInt(rbwOverlay.dataset.step), ok=true;
      if(step===1){
        if(!document.getElementById('rbundle-name').value.trim()){document.getElementById('rbundle-name-error').innerText='Required'; ok=false;} else document.getElementById('rbundle-name-error').innerText='';
        if(!document.getElementById('rbundle-prog').value){document.getElementById('rbundle-prog-error').innerText='Required'; ok=false;} else document.getElementById('rbundle-prog-error').innerText='';
      }
      if(ok){
        if(step===1){
          rbState.name=document.getElementById('rbundle-name').value.trim();
          rbState.desc=document.getElementById('rbundle-desc').value;
          rbState.program=document.getElementById('rbundle-prog').value;
          rbState.tags=document.getElementById('rbundle-tags').value;
          populateRBundleSub();
        }
        if(step===2){
          rbState.submissionForms=Array.from(document.getElementById('rbundle-sub-selected').children).map(li=>li.dataset.value);
        }
        if(step===3){
          rbState.reviewEnabled=document.getElementById('rbundle-enable-review').checked;
          if(rbState.reviewEnabled) rbState.reviewForms=Array.from(document.getElementById('rbundle-rev-selected').children).map(li=>li.dataset.value);
        }
        if(step===3 && rbState.reviewEnabled) populateRBundleRev();
        showRBundleStep(step+1);
        if(step+1===4) showRBundleSummary();
      }
    };
    document.getElementById('rbundle-prev').onclick=()=>showRBundleStep(parseInt(rbwOverlay.dataset.step)-1);
    function populateRBundleSub(){
      const avail=document.getElementById('rbundle-sub-avail');
      avail.innerHTML='';
      submissionLibrary.forEach(f=>addListItemRBundle('rbundle-sub-avail',f.name,false));
    }
    document.getElementById('rbundle-sub-search').oninput=()=>{
      const q=document.getElementById('rbundle-sub-search').value.toLowerCase();
      Array.from(document.getElementById('rbundle-sub-avail').children).forEach(li=>{
        li.style.display=li.dataset.value.toLowerCase().includes(q)?'flex':'none';
      });
    };
    function populateRBundleRev(){
      const avail=document.getElementById('rbundle-rev-avail');
      avail.innerHTML='';
      reviewLibrary.forEach(f=>addListItemRBundle('rbundle-rev-avail',f.name,false));
    }
    document.getElementById('rbundle-rev-search').oninput=()=>{
      const q=document.getElementById('rbundle-rev-search').value.toLowerCase();
      Array.from(document.getElementById('rbundle-rev-avail').children).forEach(li=>{
        li.style.display=li.dataset.value.toLowerCase().includes(q)?'flex':'none';
      });
    };
    document.getElementById('rbundle-enable-review').onchange=e=>{
      document.getElementById('rbundle-review-section').style.display=e.target.checked?'block':'none';
    };
    function addListItemRBundle(listId,text,selected){
      const ul=document.getElementById(listId);
      if(Array.from(ul.children).some(li=>li.dataset.value===text)) return;
      const li=document.createElement('li');
      li.dataset.value=text;
      li.innerHTML=`<span>${text}</span><div>
        ${selected?'<button class="order-btn">↑</button><button class="order-btn">↓</button>':''}
        <button class="order-btn">${selected?'-':'+'}</button>
      </div>`;
      ul.appendChild(li);
      const btn=li.querySelector('button:last-child');
      btn.onclick=()=>{
        li.remove();
        const target=listId==='rbundle-sub-avail'?'rbundle-sub-selected':'rbundle-sub-avail';
        if(listId.startsWith('rbundle-rev')) target=listId==='rbundle-rev-avail'?'rbundle-rev-selected':'rbundle-rev-avail';
        addListItemRBundle(target,text,target.endsWith('selected'));
      };
      if(selected){
        const up=li.querySelector('button:first-child');
        const down=li.querySelector('button:nth-child(2)');
        up.onclick=()=>{const prev=li.previousElementSibling; if(prev) ul.insertBefore(li,prev);}
        down.onclick=()=>{const next=li.nextElementSibling; if(next) ul.insertBefore(next,li);}
      }
    }
    function showRBundleSummary(){
      const sum=document.getElementById('rbundle-summary');
      sum.innerHTML=`
        <p><strong>Name:</strong> ${rbState.name}</p>
        <p><strong>Description:</strong> ${rbState.desc}</p>
        <p><strong>Program:</strong> ${rbState.program}</p>
        <p><strong>Tags:</strong> ${rbState.tags}</p>
        <p><strong>Submission Forms:</strong> ${rbState.submissionForms.join(', ')}</p>
        <p><strong>Review Enabled:</strong> ${rbState.reviewEnabled?'Yes':'No'}</p>
        <p><strong>Review Forms:</strong> ${rbState.reviewForms.join(', ')}</p>`;
    }
    document.getElementById('rbundle-finish').onclick=()=>{
      rbState.id=rbMode==='create'?Date.now().toString():rbState.id;
      if(rbMode==='create') rbundles.push(rbState);
      else { const idx=rbundles.findIndex(x=>x.id===rbState.id); rbundles[idx]=rbState; }
      rbwOverlay.style.display='none'; renderRBundles();
    };

    // Deliverable Wizard
    let delState={}, delMode='create';
    const dowOverlay=document.getElementById('deliverable-wizard-overlay');
    function openDeliverableWizard(mode,name){
      delMode=mode; delState={};
      dowOverlay.style.display='flex';
      document.getElementById('del-wizard-title').innerText= mode==='edit'?'Edit Deliverable':'New Deliverable';
      showDelStep(1);
      document.querySelectorAll('#deliverable-wizard-overlay input, #deliverable-wizard-overlay select').forEach(el=>el.value='');
      document.querySelectorAll('#deliverable-wizard-overlay .error').forEach(e=>e.innerText='');
      const csel=document.getElementById('del-cohort'), bsel=document.getElementById('del-bundle');
      csel.innerHTML='<option value="">Select</option>'; cohorts.forEach(c=>csel.add(new Option(c.name,c.name)));
      bsel.innerHTML='<option value="">Select</option>'; bundles.forEach(b=>bsel.add(new Option(b.name,b.name)));
      if(mode==='edit'){
        const item=deliverables.find(x=>x.name===name);
        delState=JSON.parse(JSON.stringify(item));
        document.getElementById('del-name').value=item.name;
        document.getElementById('del-cohort').value=item.cohort;
        document.getElementById('del-bundle').value=item.bundle;
        if(item.schedule.startsWith('One-time')){
          document.querySelector('input[name="del-sched-type"][value="one-time"]').checked=true;
          showDelSched();
          document.getElementById('del-date').value=item.nextRun;
        } else {
          document.querySelector('input[name="del-sched-type"][value="recurring"]').checked=true;
          showDelSched();
          document.getElementById('del-cron').value=item.schedule.match(/\((.*)\)/)[1];
        }
        document.getElementById('del-template').value=item.notificationTemplateId||'';
        document.getElementById('del-reminders').value=item.reminderDays?item.reminderDays.join(','):'';
      }
    }
    document.getElementById('open-deliverable-wizard').onclick=()=>openDeliverableWizard('create');
    document.getElementById('del-cancel').onclick=()=>dowOverlay.style.display='none';
    function showDelStep(n){
      showStep(dowOverlay, n);
      document.getElementById('del-prev').style.display=n>1?'inline-block':'none';
      document.getElementById('del-next').style.display=n<4?'inline-block':'none';
      document.getElementById('del-finish').style.display=n===4?'inline-block':'none';
      dowOverlay.dataset.step=n;
    }
    document.getElementById('del-next').onclick=()=>{
      let step=parseInt(dowOverlay.dataset.step), ok=true;
      if(step===1){
        if(!document.getElementById('del-name').value.trim()){document.getElementById('del-name-error').innerText='Required'; ok=false;} else document.getElementById('del-name-error').innerText='';
        if(!document.getElementById('del-cohort').value){document.getElementById('del-cohort-error').innerText='Required'; ok=false;} else document.getElementById('del-cohort-error').innerText='';
        if(!document.getElementById('del-bundle').value){document.getElementById('del-bundle-error').innerText='Required'; ok=false;} else document.getElementById('del-bundle-error').innerText='';
        delState.name=document.getElementById('del-name').value.trim();
        delState.cohort=document.getElementById('del-cohort').value;
        delState.bundle=document.getElementById('del-bundle').value;
      }
      if(step===2){
        const type=document.querySelector('input[name="del-sched-type"]:checked').value;
        if(type==='one-time'){
          if(!document.getElementById('del-date').value){document.getElementById('del-date-error').innerText='Required'; ok=false;} else document.getElementById('del-date-error').innerText='';
          delState.schedule=`One-time (${document.getElementById('del-date').value})`;
          delState.nextRun=document.getElementById('del-date').value;
        } else {
          if(!document.getElementById('del-cron').value.trim()){document.getElementById('del-cron-error').innerText='Required'; ok=false;} else document.getElementById('del-cron-error').innerText='';
          delState.schedule=`Recurring (${document.getElementById('del-cron').value})`;
          delState.nextRun='';
        }
      }
      if(step===3){
        if(!document.getElementById('del-template').value){document.getElementById('del-template-error').innerText='Required'; ok=false;} else document.getElementById('del-template-error').innerText='';
        delState.notificationTemplateId=document.getElementById('del-template').value;
        delState.reminderDays=document.getElementById('del-reminders').value.split(',').map(x=>x.trim()).filter(x=>x).map(Number);
      }
      if(ok){
        showDelStep(step+1);
        if(step+1===4) showDelSummary();
      }
    };
    document.getElementById('del-prev').onclick=()=>showDelStep(parseInt(dowOverlay.dataset.step)-1);
    document.querySelectorAll('input[name="del-sched-type"]').forEach(r=>r.onchange=showDelSched);
    function showDelSched(){
      const type=document.querySelector('input[name="del-sched-type"]:checked').value;
      document.getElementById('del-one-time').style.display=type==='one-time'?'block':'none';
      document.getElementById('del-recurring').style.display=type==='recurring'?'block':'none';
    }
    function showDelSummary(){
      const sum=document.getElementById('del-summary');
      sum.innerHTML=`
        <p><strong>Name:</strong> ${delState.name}</p>
        <p><strong>Cohort:</strong> ${delState.cohort}</p>
        <p><strong>Bundle:</strong> ${delState.bundle}</p>
        <p><strong>Schedule:</strong> ${delState.schedule}</p>
        <p><strong>Next Run:</strong> ${delState.nextRun}</p>
        <p><strong>Template:</strong> ${delState.notificationTemplateId}</p>
        <p><strong>Reminder Days:</strong> ${delState.reminderDays.join(', ')}</p>`;
    }
    document.getElementById('del-finish').onclick=()=>{
      delState.id=delMode==='create'?Date.now().toString():delState.id;
      delState.lastRunStatus='Pending';
      if(delMode==='create') deliverables.push(delState);
      else { const idx=deliverables.findIndex(x=>x.id===delState.id); deliverables[idx]=delState; }
      dowOverlay.style.display='none'; renderDeliverables();
    };

    // Tenant Wizard Logic
    let tenantState={}, tenantMode='create';
    const tenantOverlay=document.getElementById('tenant-wizard-overlay');
    function openTenantWizard(mode,name){
      tenantMode=mode; tenantState={};
      tenantOverlay.style.display='flex';
      document.getElementById('tenant-wizard-title').innerText=mode==='edit'?'Edit Tenant':'New Tenant';
      showTenantStep(1);
      document.getElementById('tenant-name').value='';
      document.getElementById('tenant-desc').value='';
      document.getElementById('tenant-name-error').innerText='';
      if(mode==='edit'){
        const item=tenants.find(x=>x.name===name);
        tenantState=JSON.parse(JSON.stringify(item));
        document.getElementById('tenant-name').value=item.name;
        document.getElementById('tenant-desc').value=item.description;
      }
    }
    document.getElementById('open-tenant-wizard').onclick=()=>openTenantWizard('create');
    document.getElementById('tenant-cancel').onclick=()=>tenantOverlay.style.display='none';
    function showTenantStep(n){
      showStep(tenantOverlay, n);
      document.getElementById('tenant-prev').style.display=n>1?'inline-block':'none';
      document.getElementById('tenant-next').style.display=n<2?'inline-block':'none';
      document.getElementById('tenant-finish').style.display=n===2?'inline-block':'none';
      tenantOverlay.dataset.step=n;
    }
    document.getElementById('tenant-next').onclick=()=>{
      let ok=true;
      if(!document.getElementById('tenant-name').value.trim()){document.getElementById('tenant-name-error').innerText='Required'; ok=false;} else document.getElementById('tenant-name-error').innerText='';
      if(ok){
        tenantState.name=document.getElementById('tenant-name').value.trim();
        tenantState.description=document.getElementById('tenant-desc').value;
        document.getElementById('tenant-summary').innerHTML=`
          <p><strong>Name:</strong> ${tenantState.name}</p>
          <p><strong>Description:</strong> ${tenantState.description}</p>`;
        showTenantStep(2);
      }
    };
    document.getElementById('tenant-prev').onclick=()=>showTenantStep(1);
    document.getElementById('tenant-finish').onclick=()=>{
      if(tenantMode==='create'){
        tenantState.id=Date.now().toString();
        tenants.push(tenantState);
      } else {
        const idx=tenants.findIndex(x=>x.id===tenantState.id);
        tenants[idx]=tenantState;
      }
      tenantOverlay.style.display='none'; renderTenants();
    };

    // Entity Wizard Logic
    let entityState={}, entityMode='create';
    const entityOverlay=document.getElementById('entity-wizard-overlay');
    function populateEntityParents(){
      const sel=document.getElementById('entity-parent');
      sel.innerHTML='<option value="">None</option>';
      entities.forEach(e=>sel.add(new Option(e.name,e.id)));
    }
    function openEntityWizard(mode,name){
      entityMode=mode; entityState={attributes:[],childCount:0,parent:''};
      entityOverlay.style.display='flex';
      document.getElementById('entity-wizard-title').innerText=mode==='edit'?'Edit Entity':'New Entity';
      showEntityStep(1);
      document.getElementById('entity-name').value='';
      document.getElementById('entity-type').value='';
      document.getElementById('entity-parent').value='';
      document.getElementById('entity-name-error').innerText='';
      document.getElementById('entity-type-error').innerText='';
      document.querySelector('#entity-attributes-table tbody').innerHTML='';
      populateEntityParents();
      if(mode==='edit'){
        const item=entities.find(x=>x.name===name);
        entityState=JSON.parse(JSON.stringify(item));
        document.getElementById('entity-name').value=item.name;
        document.getElementById('entity-type').value=item.type;
        document.getElementById('entity-parent').value=item.parent;
        item.attributes.forEach(attr=>addAttributeRow(attr));
      }
    }
    document.getElementById('open-entity-wizard').onclick=()=>openEntityWizard('create');
    document.getElementById('entity-cancel').onclick=()=>entityOverlay.style.display='none';
    function showEntityStep(n){
      showStep(entityOverlay, n);
      document.getElementById('entity-prev').style.display=n>1?'inline-block':'none';
      document.getElementById('entity-next').style.display=n<4?'inline-block':'none';
      document.getElementById('entity-finish').style.display=n===4?'inline-block':'none';
      entityOverlay.dataset.step=n;
      if(n===2) populateEntityParents();
      if(n===4) showEntitySummary();
    }
    document.getElementById('entity-next').onclick=()=>{
      let step=parseInt(entityOverlay.dataset.step), ok=true;
      if(step===1){
        if(!document.getElementById('entity-name').value.trim()){document.getElementById('entity-name-error').innerText='Required'; ok=false;} else document.getElementById('entity-name-error').innerText='';
        if(!document.getElementById('entity-type').value){document.getElementById('entity-type-error').innerText='Required'; ok=false;} else document.getElementById('entity-type-error').innerText='';
      }
      if(step===2){
        entityState.parent=document.getElementById('entity-parent').value;
      }
      if(step===3){
        const attrs=[];
        document.querySelectorAll('#entity-attributes-table tbody tr').forEach(tr=>{
          attrs.push({
            name:tr.querySelector('.attr-name').value,
            type:tr.querySelector('.attr-type').value,
            required:tr.querySelector('.attr-required').checked
          });
        });
        entityState.attributes=attrs;
      }
      if(ok){
        if(step===1){
          entityState.name=document.getElementById('entity-name').value.trim();
          entityState.type=document.getElementById('entity-type').value;
        }
        showEntityStep(step+1);
      }
    };
    document.getElementById('entity-prev').onclick=()=>showEntityStep(parseInt(entityOverlay.dataset.step)-1);
    document.getElementById('entity-add-attr').onclick=()=>addAttributeRow();
    function addAttributeRow(attr){
      const tbody=document.querySelector('#entity-attributes-table tbody');
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input type="text" class="attr-name" value="${attr?attr.name:''}"></td>
        <td><select class="attr-type"><option value="string">string</option><option value="number">number</option><option value="boolean">boolean</option><option value="date">date</option><option value="enum">enum</option></select></td>
        <td><input type="checkbox" class="attr-required"${attr&&attr.required?' checked':''}></td>
        <td>
          <button class="order-btn up-attr">↑</button>
          <button class="order-btn down-attr">↓</button>
          <button class="order-btn delete-attr">×</button>
        </td>`;
      tbody.appendChild(tr);
      if(attr) tr.querySelector('.attr-type').value=attr.type;
      tr.querySelector('.delete-attr').onclick=()=>tr.remove();
      tr.querySelector('.up-attr').onclick=()=>{const prev=tr.previousElementSibling; if(prev) tbody.insertBefore(tr,prev);};
      tr.querySelector('.down-attr').onclick=()=>{const next=tr.nextElementSibling; if(next) tbody.insertBefore(next,tr);};
    }
    function showEntitySummary(){
      const sum=document.getElementById('entity-summary');
      const parentName=(entities.find(x=>x.id===entityState.parent)||{}).name||'None';
      sum.innerHTML=`
        <p><strong>Name:</strong> ${entityState.name}</p>
        <p><strong>Type:</strong> ${entityState.type}</p>
        <p><strong>Parent Entity:</strong> ${parentName}</p>
        <p><strong>Attributes:</strong><br>${entityState.attributes.map(a=>`${a.name} (${a.type})${a.required?' [required]':''}`).join('<br>')}</p>`;
    }
    document.getElementById('entity-finish').onclick=()=>{
      entityState.id=entityMode==='create'?Date.now().toString():entityState.id;
      if(entityMode==='create'){
        entities.push(entityState);
      } else {
        const idx=entities.findIndex(x=>x.id===entityState.id);
        entities[idx]=entityState;
      }
      entityOverlay.style.display='none'; renderEntities();
    };
  </script>
</body>
</html>
